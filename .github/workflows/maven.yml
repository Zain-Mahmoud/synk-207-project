name: PR Code Quality Checks

on:
  pull_request:
    branches:
      - main # Replace with your main/base branch name if different

jobs:
  checkstyle_changed_files:
    runs-on: ubuntu-latest
    
    # Only proceed if the PR is not merged and the base branch is the target branch
    if: github.event_name == 'pull_request' && github.event.pull_request.state != 'closed'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch depth 0 is crucial to get the history needed for git diff
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Find Changed Java Files and Run Checkstyle
        id: checkstyle_runner
        run: |
          # 1. Determine the base and head commits for comparison
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"

          # 2. Get a list of only .java files changed between the base and head
          # --diff-filter=AMR: only check Added, Modified, or Renamed files
          echo "Comparing changes between $BASE_SHA and $HEAD_SHA"
          CHANGED_FILES=$(git diff --name-only --diff-filter=AMR $BASE_SHA $HEAD_SHA | grep -E '.*\.java$' || true)
          
          # 3. Check if any Java files were changed
          if [ -z "$CHANGED_FILES" ]; then
              echo "No .java files changed in this PR. Checkstyle skipped."
              exit 0
          fi

          # 4. Convert the space-separated list (from git) to a comma-separated list (for Maven)
          INCLUDES=$(echo $CHANGED_FILES | sed 's/ /,/g')
          
          echo "Running Checkstyle on the following files:"
          echo "$INCLUDES"
          
          # 5. Execute Maven Checkstyle goal
          # -Dcheckstyle.includes=$INCLUDES: Limits the check to only the changed files.
          # -Dcheckstyle.excludes="": Important to clear any default excludes.
          # -DconfigLocation=mystyle.xml: (This is already set in your pom, but good to ensure)
          # -Dcheckstyle.failOnViolation=true: Ensures the job fails if a violation is found.
          mvn checkstyle:check \
              -Dcheckstyle.includes="$INCLUDES" \
              -Dcheckstyle.excludes="" \
              -Dcheckstyle.failOnViolation=true
